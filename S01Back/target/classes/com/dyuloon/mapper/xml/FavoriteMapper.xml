<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.dyuloon.mapper.FavoriteMapper">

    <!-- 根据用户ID获取收藏列表（按排序） -->
    <select id="selectByUserIdOrderBySort" resultType="com.dyuloon.entity.Favorite">
        SELECT id, user_id as userId, module_id as moduleId, module_name as moduleName, 
               description, icon, port, url, sort_order as sortOrder, 
               created_at as createdAt, updated_at as updatedAt
        FROM user_favorites 
        WHERE user_id = #{userId}
        ORDER BY sort_order ASC, created_at ASC
    </select>

    <!-- 检查用户是否已收藏该模块 -->
    <select id="selectByUserIdAndModuleId" resultType="com.dyuloon.entity.Favorite">
        SELECT id, user_id as userId, module_id as moduleId, module_name as moduleName, 
               description, icon, port, url, sort_order as sortOrder, 
               created_at as createdAt, updated_at as updatedAt
        FROM user_favorites 
        WHERE user_id = #{userId} AND module_id = #{moduleId}
    </select>

    <!-- 获取用户收藏的最大排序号 -->
    <select id="selectMaxSortOrderByUserId" resultType="java.lang.Integer">
        SELECT COALESCE(MAX(sort_order), 0) 
        FROM user_favorites 
        WHERE user_id = #{userId}
    </select>

    <!-- 更新收藏排序 -->
    <update id="updateSortOrder">
        UPDATE user_favorites 
        SET sort_order = #{sortOrder}, updated_at = NOW()
        WHERE user_id = #{userId} AND module_id = #{moduleId}
    </update>

</mapper>
